# ADR-001 — Arquitetura, Mensageria e Propriedade da Topologia AMQP

**Status**: Aceita  
**Data**: 2025-09-29

## Contexto

O produto **Cashflow Ledger Platform** é composto por quatro serviços principais:

- **API Gateway**: roteia chamadas e aplica *rate limiting* e autenticação por API Key.
- **Ledger Service**: recebe lançamentos (contábeis), persiste no schema `ledger` e publica eventos de domínio.
- **Consolidator Service**: consome eventos, consolida saldos/projeções e grava no schema `report`.
- **Balance Query Service**: expõe consultas de leitura sobre `report`.

Requisitos não funcionais:
- Mensageria resiliente, com *back-pressure*, descarte controlado e recuperação por *rebuild*.
- Idempotência, *replay* seguro e *at-least-once* na leitura.
- Observabilidade (Prometheus/Grafana) e *health checks*.

## Decisão

1. **Padrão Outbox no Ledger**  
   - O Ledger grava o evento na tabela outbox na mesma transação do lançamento, e um *publisher* assíncrono envia o evento para o broker.  
   - Garante atomicidade entre escrita do estado e publicação do fato (mitiga *dual write*).

2. **Ledger é *publish-only***  
   - O Ledger **não** declara *queues/exchanges/bindings* e **não** executa `RabbitAdmin`.  
   - Propriedades de execução:  
     `spring.rabbitmq.dynamic=false`,  
     `spring.rabbitmq.listener.simple.missing-queues-fatal=false`,  
     `spring.amqp.admin.auto-startup=false`,  
     *publisher returns/confirm* e `RabbitTemplate.mandatory=true` habilitados.

3. **Consolidator é o **dono explícito** da topologia AMQP**  
   - Declara **exchanges**, **queues** e **bindings** via um único `Declarables`.  
   - Habilita `spring.amqp.admin.auto-startup=true` para efetuar as declarações no *startup*.  
   - Configuração das filas:  
     - **Main queue** `report.ledger.entry-recorded.q`: `x-queue-type=quorum`, `x-dead-letter-exchange=ledger.dlx`, `x-dead-letter-routing-key=ledger.entry-recorded.dlq`.  
     - **DLQ** `report.ledger.entry-recorded.dlq`: `x-queue-type=quorum`, `x-message-ttl` (expurgo controlado), `x-overflow=reject-publish`.  
   - Motivação: concentrar a responsabilidade de topologia no consumidor primário reduz *drift*, evita falhas `PRECONDITION_FAILED` e facilita governança.

4. **Leituras desacopladas e *rebuild***  
   - O Consolidator atualiza somente o schema `report`; o serviço de consulta apenas **lê** esse schema.  
   - Para inconsistências, há comando de *rebuild* que recalcula projeções a partir do *write model* e/ou do histórico de eventos.

5. **Observabilidade e Saúde**  
   - Prometheus coleta métricas de serviços e RabbitMQ.  
   - Grafana provê dashboards. *Health checks* expostos em `/actuator/health`.

6. **Segurança/Entrada**  
   - API Gateway aplica *rate limiting* e valida API Key antes de encaminhar requisições.

## Alternativas Consideradas

- **Serviço produtor declarar topologia**: rejeitada por aumentar acoplamento e risco de conflitos de argumentos entre produtores e consumidores.
- **Kafka em vez de RabbitMQ**: não selecionado nesta fase. RabbitMQ (quorum queues, DLX, TTL, overflow) atende requisitos com menor *overhead* operacional. Kafka permanece opção futura para *event streaming* amplo.
- **Filas clássicas**: preteridas em favor de **quorum queues** (robustez e consistência).

## Consequências

**Positivas**
- Partilha clara de responsabilidades: produtor (*publish-only*), consumidor (dono da topologia).  
- Redução de erros de arranque e conflitos de argumentos no broker.  
- *Back-pressure* e retenção previsíveis via DLQ com TTL e `x-overflow=reject-publish`.  
- Reprocessamento seguro através de *rebuild*.

**Negativas / Custos**
- Consolidator passa a ser crítico na criação/alteração da topologia. Mudanças exigem *deploy* coordenado.  
- Maior disciplina na gestão de versões de mensagens (contratos).

## Implicações Operacionais

- Ao detectar *drift* de argumentos no broker, remover a DLQ e deixar o Consolidator recriar.  
- Pipelines de CI publicam artefatos de teste em `out/<RunId>/` com requisições e respostas para auditoria.  
- Documentação: README e C4 (Contexto, Containers, Componentes) atualizados.
